var spotifyLyrics=(function(){"use strict";function it(t){return t}const l=globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome,z={matches:["*://open.spotify.com/*"],runAt:"document_idle",main:X},f="sly-lyrics-controls";let i="original",s="original",g="en",c=!0,q="",o={original:[],processed:new Map},w=null,y=null,L=0,C=null,T=null,A=!1,d=null;function B(t,e=0){let n=document.getElementById("sly-toast");n||(n=document.createElement("div"),n.id="sly-toast",n.className="sly-toast",document.body.appendChild(n)),d&&clearTimeout(d),n.textContent=t,n.classList.add("visible"),e>0&&(d=setTimeout(()=>P(),e))}function P(t=!1){const e=document.getElementById("sly-toast");e&&(t&&d!==null||(e.classList.remove("visible"),d&&(clearTimeout(d),d=null)))}const I=()=>Array.from(document.querySelectorAll('[data-testid="lyrics-line"] > div')),b=()=>document.querySelector('[data-testid="lyrics-line"]')?.parentElement??null,U=()=>document.querySelector('[data-testid="now-playing-widget"]')?.getAttribute("aria-label")??"",R=()=>document.querySelector('[data-testid="lyrics-button"]:not([disabled])')!==null;function _(){const t=I();t.forEach(e=>{if(e.hasAttribute("data-sly-original"))return;const n=e.querySelector(".sly-dual-line");if(n){e.setAttribute("data-sly-original",n.textContent??"");return}const r=e.querySelector(".sly-main-line");if(r){e.setAttribute("data-sly-original",r.textContent??"");return}e.setAttribute("data-sly-original",e.textContent??"")}),o.original=t.map(e=>e.getAttribute("data-sly-original")??"")}function k(t){if(document.getElementById(f))return;const e=document.createElement("div");e.id=f,e.className="sly-lyrics-controls";const n=i==="original"&&s!=="original"?s:i;["original","romanized","translated"].forEach(r=>{const a=document.createElement("button");a.className=`sly-lyrics-btn${n===r?" active":""}`,a.textContent=r.charAt(0).toUpperCase()+r.slice(1),a.dataset.mode=r,a.addEventListener("click",()=>v(r)),e.appendChild(a)}),t.insertBefore(e,t.firstChild)}function x(){document.getElementById(f)?.querySelectorAll(".sly-lyrics-btn").forEach(t=>t.classList.toggle("active",t.dataset.mode===i))}function O(t){document.getElementById(f)?.querySelectorAll(".sly-lyrics-btn").forEach(e=>e.disabled=t),b()?.classList.toggle("sly-loading",t)}function p(t,e){Array.isArray(t)&&(A=!0,I().forEach((n,r)=>{if(t[r]===void 0)return;if(e?.[r]!==void 0&&n.setAttribute("data-sly-original",e[r]),c&&e!==void 0&&e[r]!==void 0&&e[r]!==t[r]){n.textContent="";const m=document.createElement("span");m.className="sly-main-line",m.textContent=t[r],n.appendChild(m);const u=document.createElement("span");u.className="sly-dual-line",u.textContent=e[r],n.appendChild(u)}else n.textContent=t[r]}),setTimeout(()=>{A=!1},0))}function G(){y?.disconnect();const t=b();t&&(y=new MutationObserver(()=>{if(A||i==="original")return;const e=o.processed.get(g);if(!e)return;const n=i==="romanized"?e.romanized:e.translated;I().some((m,u)=>{if(n[u]===void 0)return!1;const V=m.querySelector(".sly-main-line");return V?V.textContent!==n[u]:m.textContent!==n[u]})&&p(n,c?o.original:void 0)}),y.observe(t,{subtree:!0,childList:!0,characterData:!0}))}async function W(){return(await l.storage.sync.get("targetLang")).targetLang??"en"}async function Y(t,e){if(o.processed.has(e))return o.processed.get(e);const n=++L,r=await l.runtime.sendMessage({type:"PROCESS",lines:t,targetLang:e});return n!==L||!r||!Array.isArray(r.translated)?null:(o.processed.set(e,r),r)}async function v(t,e){if(!(t===i&&e===void 0)){o.original.length===0&&_(),O(!0);try{if(t==="original")i=t,s=t,l.storage.sync.set({preferredMode:t}),p(o.original);else{const n=e??await W(),r=await Y(o.original,n);if(r===null)return;g=n,i=t,s=t,l.storage.sync.set({preferredMode:t});const a=t==="romanized"?r.romanized:r.translated;p(a,c?o.original:void 0)}x()}catch(n){console.error("[SlyLyrics] Mode switch failed:",n),B("Translation failed. Please try again.",3e3),i=i===t?"original":i,x()}finally{P(!0),O(!1)}}}async function j(){if(i==="original")return;const t=o.processed.get(g);if(!t)return;const e=i==="romanized"?t.romanized:t.translated;p(e,c?o.original:void 0)}function K(){i==="original"&&s!=="original"&&v(s)}async function N(){if(!R())return;const t=b();t&&(o.original.length===0&&_(),k(t),G(),await j(),K())}function F(){C&&cancelAnimationFrame(C),C=requestAnimationFrame(()=>N())}function D(t=0){t>120||(R()&&b()?N():T=requestAnimationFrame(()=>D(t+1)))}function H(t){t!==q&&(q=t,i="original",L++,y?.disconnect(),y=null,o={original:[],processed:new Map},document.getElementById(f)?.remove(),T&&cancelAnimationFrame(T),D())}function J(){l.storage.onChanged.addListener((t,e)=>{if(e==="sync"){if("targetLang"in t&&i==="translated"){const n=t.targetLang.newValue??"en";v("translated",n)}if("dualLyrics"in t&&(c=t.dualLyrics.newValue??!0,i!=="original"&&o.original.length>0)){const n=o.processed.get(g);if(n){const r=i==="romanized"?n.romanized:n.translated;p(r,c?o.original:void 0)}}if("preferredMode"in t){const n=t.preferredMode.newValue??"original";s=n,n==="original"&&i!=="original"&&v("original")}}})}function Q(){w||(w=new MutationObserver(t=>{for(const e of t){if(e.type==="attributes"&&e.attributeName==="aria-label"&&e.target.closest('[data-testid="now-playing-widget"]')){H(U());continue}if(e.type==="childList"){for(const n of e.addedNodes)if(n instanceof Element&&(n.matches('[data-testid="lyrics-line"]')||n.querySelector('[data-testid="lyrics-line"]'))){F();break}for(const n of e.removedNodes)if(n instanceof Element&&n.id===f){F();break}}}}),w.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["aria-label"]}))}async function X(){try{const t=await l.storage.sync.get(["dualLyrics","targetLang","preferredMode"]);c=t.dualLyrics!==void 0?t.dualLyrics:!0,g=t.targetLang??"en",s=t.preferredMode??"original"}catch{console.warn("[SlyLyrics] storage.sync unavailable, using defaults"),c=!0,g="en",s="original"}Q(),J(),N()}function S(t,...e){}const Z={debug:(...t)=>S(console.debug,...t),log:(...t)=>S(console.log,...t),warn:(...t)=>S(console.warn,...t),error:(...t)=>S(console.error,...t)};var tt=class $ extends Event{static EVENT_NAME=M("wxt:locationchange");constructor(e,n){super($.EVENT_NAME,{}),this.newUrl=e,this.oldUrl=n}};function M(t){return`${l?.runtime?.id}:spotify-lyrics:${t}`}function et(t){let e,n;return{run(){e==null&&(n=new URL(location.href),e=t.setInterval(()=>{let r=new URL(location.href);r.href!==n.href&&(window.dispatchEvent(new tt(r,n)),n=r)},1e3))}}}var nt=class h{static SCRIPT_STARTED_MESSAGE_TYPE=M("wxt:content-script-started");id;abortController;locationWatcher=et(this);constructor(e,n){this.contentScriptName=e,this.options=n,this.id=Math.random().toString(36).slice(2),this.abortController=new AbortController,this.stopOldScripts(),this.listenForNewerScripts()}get signal(){return this.abortController.signal}abort(e){return this.abortController.abort(e)}get isInvalid(){return l.runtime?.id==null&&this.notifyInvalidated(),this.signal.aborted}get isValid(){return!this.isInvalid}onInvalidated(e){return this.signal.addEventListener("abort",e),()=>this.signal.removeEventListener("abort",e)}block(){return new Promise(()=>{})}setInterval(e,n){const r=setInterval(()=>{this.isValid&&e()},n);return this.onInvalidated(()=>clearInterval(r)),r}setTimeout(e,n){const r=setTimeout(()=>{this.isValid&&e()},n);return this.onInvalidated(()=>clearTimeout(r)),r}requestAnimationFrame(e){const n=requestAnimationFrame((...r)=>{this.isValid&&e(...r)});return this.onInvalidated(()=>cancelAnimationFrame(n)),n}requestIdleCallback(e,n){const r=requestIdleCallback((...a)=>{this.signal.aborted||e(...a)},n);return this.onInvalidated(()=>cancelIdleCallback(r)),r}addEventListener(e,n,r,a){n==="wxt:locationchange"&&this.isValid&&this.locationWatcher.run(),e.addEventListener?.(n.startsWith("wxt:")?M(n):n,r,{...a,signal:this.signal})}notifyInvalidated(){this.abort("Content script context invalidated"),Z.debug(`Content script "${this.contentScriptName}" context invalidated`)}stopOldScripts(){document.dispatchEvent(new CustomEvent(h.SCRIPT_STARTED_MESSAGE_TYPE,{detail:{contentScriptName:this.contentScriptName,messageId:this.id}})),window.postMessage({type:h.SCRIPT_STARTED_MESSAGE_TYPE,contentScriptName:this.contentScriptName,messageId:this.id},"*")}verifyScriptStartedEvent(e){const n=e.detail?.contentScriptName===this.contentScriptName,r=e.detail?.messageId===this.id;return n&&!r}listenForNewerScripts(){const e=n=>{!(n instanceof CustomEvent)||!this.verifyScriptStartedEvent(n)||this.notifyInvalidated()};document.addEventListener(h.SCRIPT_STARTED_MESSAGE_TYPE,e),this.onInvalidated(()=>document.removeEventListener(h.SCRIPT_STARTED_MESSAGE_TYPE,e))}};function at(){}function E(t,...e){}const rt={debug:(...t)=>E(console.debug,...t),log:(...t)=>E(console.log,...t),warn:(...t)=>E(console.warn,...t),error:(...t)=>E(console.error,...t)};return(async()=>{try{const{main:t,...e}=z;return await t(new nt("spotify-lyrics",e))}catch(t){throw rt.error('The content script "spotify-lyrics" crashed on startup!',t),t}})()})();
spotifyLyrics;